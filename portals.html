<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Securable Portals</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/inter-ui/3.19.3/inter.css" rel="stylesheet">
<script src="https://cdn.auth0.com/js/auth0-spa-js/2.5/auth0-spa-js.production.js"></script>

<style>
    :root {
        --bg: #f8fafc;
        --text: #0f172a;
        --subtle: #64748b;
        --card: #ffffff;
        --border: #e2e8f0;
        --primary: #2563eb;
        --primary-hover: #1e40af;
    }

    body {
        margin: 0; font-family: 'Inter', sans-serif;
        background: var(--bg); color: var(--text);
    }

    header {
        padding: 18px 40px;
        background: rgba(255,255,255,.95);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border);
        display: flex; justify-content: space-between; align-items: center;
    }

    .profile-btn { width:40px; height:40px; border-radius:50%; overflow:hidden; border:2px solid var(--border); cursor:pointer; display:none; }
    .profile-btn img { width:100%; height:100%; object-fit:cover; }

    .profile-menu {
        position:absolute; top:60px; right:40px;
        width:200px; background:white; border-radius:12px;
        border:1px solid var(--border); display:none;
    }

    main { max-width:1000px; margin:60px auto; padding:0 20px; }

    #loggedOutBox, #loggedInBox {
        background:white; border:1px solid var(--border); padding:30px; border-radius:16px;
    }

    .portals-grid {
        display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
        gap:20px; margin-top:30px;
    }

    .portal-card {
        padding:20px; border:1px solid var(--border); border-radius:16px; background:white;
        transition:.2s;
    }
    .portal-card:hover { transform:translateY(-3px); border-color:var(--primary); }

    .portal-open {
        margin-top:12px; display:inline-block;
        padding:10px 18px; border-radius:999px;
        background:var(--primary); color:white; font-size:14px;
        text-decoration:none; cursor:pointer;
    }
</style>
</head>

<body>
<header>
    <div class="logo">Securable Foundation</div>

    <a id="loginBtn" href="#" class="portal-open" style="background:var(--primary);">Login</a>

    <div id="profileBtn" class="profile-btn">
        <img id="profileImg">
    </div>

    <div id="profileMenu" class="profile-menu">
        <div style="padding:12px; border-bottom:1px solid var(--border);" id="profileName"></div>
        <a href="account.html" style="display:block; padding:10px 14px; text-decoration:none; color:var(--text);">Account</a>
        <a href="#" id="logoutBtn" style="display:block; padding:10px 14px; text-decoration:none; color:#dc2626;">Logout</a>
    </div>
</header>

<main>

    <!-- NOT LOGGED IN -->
    <div id="loggedOutBox">
        <h2>Howâ€™d you get here?</h2>
        <p>You must be signed in to access Securable Company portals.</p>
        <a href="#" id="loginBtn2" class="portal-open">Login</a>
    </div>

    <!-- LOGGED IN -->
    <div id="loggedInBox" style="display:none;">
        <h1>Your Securable Portals</h1>

        <div class="portals-grid">

            <div class="portal-card">
                <h3>KamiMath</h3>
                <p>Math learning environment for students + teachers.</p>
                <a onclick="openPortal('math')" class="portal-open">Open</a>
            </div>

            <div class="portal-card">
                <h3>KamiELA</h3>
                <p>ELA curriculum and reading-based activities.</p>
                <a onclick="openPortal('ela')" class="portal-open">Open</a>
            </div>

            <div class="portal-card">
                <h3>KAMIScience</h3>
                <p>Science lessons, activities, and simulations.</p>
                <a onclick="openPortal('science')" class="portal-open">Open</a>
            </div>

            <div class="portal-card">
                <h3>KamiHistory</h3>
                <p>Immersive historical content and learning tools.</p>
                <a onclick="openPortal('history')" class="portal-open">Open</a>
            </div>

        </div>
    </div>

</main>

<script>
let user = null;

function openPortal(subject) {
    const role = user.app_metadata?.role;
    const grade = user.app_metadata?.grade;

    const saml = "auth0_saml_token_here"; // placeholder for now

    const url =
      `https://securable.click/${subject}.html?role=${role}&grade=${grade}&saml=${saml}`;

    window.location.href = url;
}

(async () => {
    const auth0Client = await auth0.createAuth0Client({
        domain: "dev-tnhr6w3ixu052ugm.us.auth0.com",
        clientId: "cOgHvMFU7i0MqNbV6tHisyUwiMD7tJka",
        cacheLocation: "localstorage",
        authorizationParams: { redirect_uri: window.location.href }
    });

    if (location.search.includes("code=") && location.search.includes("state=")) {
        await auth0Client.handleRedirectCallback();
        history.replaceState({}, "", location.pathname);
    }

    const isAuth = await auth0Client.isAuthenticated();

    const loginButtons = [document.getElementById("loginBtn"), document.getElementById("loginBtn2")];

    loginButtons.forEach(btn => btn.onclick = (e) => {
        e.preventDefault();
        auth0Client.loginWithRedirect();
    });

    if (!isAuth) return;

    // logged in
    user = await auth0Client.getUser();

    document.getElementById("loggedOutBox").style.display = "none";
    document.getElementById("loggedInBox").style.display = "block";

    // profile in header
    document.getElementById("loginBtn").style.display = "none";
    document.getElementById("profileBtn").style.display = "block";
    document.getElementById("profileImg").src = user.picture;

    document.getElementById("profileName").innerText =
        user.name || user.email || "Signed in";

    document.getElementById("profileBtn").onclick = () => {
        const menu = document.getElementById("profileMenu");
        menu.style.display = menu.style.display === "block" ? "none" : "block";
    };

    document.getElementById("logoutBtn").onclick = (e) => {
        e.preventDefault();
        auth0Client.logout({ logoutParams: { returnTo: window.location.origin } });
    };
})();
</script>

</body>
</html>
